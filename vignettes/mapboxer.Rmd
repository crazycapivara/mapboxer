---
title: "Get started with mapboxer"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{mapboxer}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The goal of mapboxer is to make it easy to create interactive maps using [Mapbox GL JS](https://docs.mapbox.com/mapbox-gl-js/api) within R. Visualizations can be used at the R console, embedded in R Markdown documents or Shiny apps.

This guide covers the basic usage of the main components that are needed to create a visualization:

* [Map](https://docs.mapbox.com/mapbox-gl-js/api/map/): The map is the main component of your visualization to which you then add other components like layers, controls or sources. Maps are created with `mapboxer()`.

* [Sources](https://docs.mapbox.com/mapbox-gl-js/style-spec/sources/): Sources state which type of data should be displayed on the map. R objects can be converted to Mapbox sources with `as_mapbox_source()`.  

* [Layers](https://docs.mapbox.com/mapbox-gl-js/style-spec/layers/): A layer's style define how a source is displayed on the map. Furthermore, you can apply filters to the data of the source. With `add_layer()` you can add any type of layer to the map but in most cases it is easier to use one of the shorcuts like `add_circle_layer()`.  

* [Controls](https://docs.mapbox.com/mapbox-gl-js/api/markers/): Controls are use to interact with the map. Besides the standard controls like `NavigationControl` included in Mapbox GL JS, mapboxer provides additional controls. For example, `add_filter_control()` can be used to filter your data on the fly without having to set up a Shiny app.

* [Expressions](https://docs.mapbox.com/help/tutorials/mapbox-gl-js-expressions/): Expressions are pretty powerful. Among other things, they can be used for data-driven-styling or to filter your data.

* __Shiny Bindings__: With `renderMapboxer()` and `mapboxerOutput()` you can integrate your visualizations in Shiny apps. Furthermore, you can use `mapboxer_proxy()` and `send_update()` to update the already rendered widget.

## Quickstart

### Load the library

```{r setup}
library(mapboxer)
```

### Set up a map

```{r}
map <- mapboxer(
  center = c(176.9, -24.655),
  zoom = 4
)
```

### Add a layer

```{r}
map <- mapboxer(
  center = c(176.9, -24.655),
  zoom = 4
) %>%
  add_circle_layer(
    source = as_mapbox_source(quakes, lng = "long", lat = "lat"),
    circle_color = "red",
    circle_radius = 5,
    # Use mustache templates to add popups to a layer
    popup = "Magnitude: {{mag}}"
  )
```

### Display the map

```r
map
```

## Map

With `mapboxer()` you create a `map` object. This is the main component of your vizualization. To add components like layers or controls or to modify the object you use the `add_*` and `set_*` functions. The parameters passed to `mapboxer()` itself are used to configure the initial setup of your map. The `style` parameter sets the style of the basemap. By default mapboxer uses a [Carto vector style](https://github.com/CartoDB/basemap-styles). It is also possible to use raster tiles or a
background color as basemap. Therefore, you can use the helpers `use_raster_style()` or `use_background_style()`:

```r
mapboxer(style = use_raster_style())
```

The `...` parameter allows you to pass any option to the map described in the [Map API Reference](https://docs.mapbox.com/mapbox-gl-js/api/map/):

```r
mapboxer(
  center = c(176.9, -24.655),
  zoom = 4
)
```

The optional `source` parameter allows you to add a default source to the map that will be used by the layers if no source is provided. Because it is the first parameter it is easy the integrate `mapboxer()`
in your workflow:

```r
quakes %>%
  dplyr::filter(mag > 5) %>%
  as_mapbox_source(lng = "long", lat = "lat") %>%
  mapboxer(
    center = c(176.9, -24.655),
    zoom = 4 
  ) %>%
  add_circle_layer(circle_color = "red")
```

As you can see above mapboxer is designed to use the widely used piping style provided by [magrittr](https://magrittr.tidyverse.org/).

## Sources

Sources state which data the map should display. To show the data on the map you need
to bind a source to a layer which contains the styling details like color or width. 
This makes it possible the style the same source in different ways.
The easiest way to create a source from an R data object is to use `as_mapbox_source()`.
Supported structures are [sf](https://r-spatial.github.io/sf/index.html)-objects and data frames that contain longitudes and latitudes:

```r
quakes_sf <- quakes %>%
  sf::st_as_sf(coords = c("long", "lat"))

quakes_source_from_sf <- quakes_sf %>%
  as_mapbox_source()

quakes_source_from_df <- quakes %>%
  as_mapbox_source(lat = "lat", long = "long")
```

With the `...` parameter you can pass further options to the source:

```r
quakes_cluster <- quakes %>%
  as_mapbox_source(
    lat = "lat",
    lng = "long",
    cluster = TRUE,
    clusterMaxZoom = 14,
    clusterRadius = 50
  )
```

See the [Sources API Reference](https://docs.mapbox.com/mapbox-gl-js/style-spec/sources/) for available options for the used source type. Source are either passed to the `add_*_layer` functions or as first parameter to `mapboxer()`.

## Layers

Layers style the data of the source to which they refer. Optionally you can filter features. Each layer must have a unique ID. If you use the generic function `add_layer()`, the type of the layer is specified by the `type` property. See the [Layers API Reference](https://docs.mapbox.com/mapbox-gl-js/style-spec/layers/) for available types. In most cases it is convenient to use one of `the add_*_layer()` functions:

```r
mapboxer(
  center = c(176.9, -24.655),
  zoom = 4
) %>%
  add_circle_layer(
    source = as_mapbox_source(quakes, lng = "long", lat = "lat"),
    circle_color = "red",
    circle_radius = 5
  )
```

## Controls

See also: [controls](https://docs.mapbox.com/mapbox-gl-js/api/markers/)

## Shiny Bindings

...
